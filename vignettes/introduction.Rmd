---
title: "Using `tobalciomodel` to Calculate Economic Impacts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using 'tobalciomodel' to Calculate Economic Impacts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, fig.height=4.5
)
```

## __Step (0) Load Required Packages__

```{r setup, warning=FALSE, message=FALSE}
library(tobalciomodel)
library(data.table)
library(dplyr)
library(tidyverse)
```

## __Step (1) Recover the Multipliers__

### Derive the model 

First transform the IO flow table (the $n$ * $n$ matrix of inter-industry purchases) into the __A__ matrix - known as the matrix of technical coefficients. This is obtained by dividing the elements of each column by total output. The elements of the matrix then represents the number of units of the sector in a given row that is required to make one unit of output in the given columns sector. 

Total output, in matrix notation, is then given by the following equation where $x$ is a vector of final demand, $Ay$ represents a vector of intermediate demand, and so $y$ is total demand which must equal total output:

$$
y = Ay + x
$$
$$
(I-A)y = x
$$

$$
y = (I-A)^{-1}x
$$

The matrix given by $(I-A)^{-1}$ is known as the *__Leontief Inverse Matrix__*. Using this matrix, the effect of any change in demand on total output can be recovered simply by re-writting the above expression in differences:

$$
\Delta y = (I-A)^{-1} \Delta x
$$

### *The Output Multiplier*

The multipliers are the coefficients which are used to translate changes in inputs into changes in output. Taking the IO equation:

$$
\Delta y = (I-A)^{-1} \Delta x
$$

An illustrative example using a simple three sector model shows the derivation of the sectoral output multipliers: 

$$
\left(\begin{array}{c} 
\Delta y_1 \\ 
\Delta y_2 \\
\Delta y_3
\end{array}\right)
=
\left(\begin{array}{ccc} 
a_{11} & a_{12} & a_{13} \\
a_{21} & a_{22} & a_{23} \\
a_{31} & a_{32} & a_{33} 
\end{array}\right)
\left(\begin{array}{c} 
\Delta x_1 \\ 
\Delta x_2 \\
\Delta x_3
\end{array}\right)
$$ 

The $a_{ij}$ are the Leontief matrix elements for industry $j$ purchases from industry $i$. $x_{j}$ are the changes in industry $j$ final demand - this can come from export demand, household demand, or government purchases.  We can express this as a system of linear equations:

$$
\Delta y_1 = (a_{11}*\Delta x_1) + (a_{12}*\Delta x_2) + (a_{13}*\Delta x_3) \\
\Delta y_2 = (a_{21}*\Delta x_1) + (a_{32}*\Delta x_2) + (a_{23}*\Delta x_3) \\
\Delta y_3 = (a_{31}*\Delta x_1) + (a_{32}*\Delta x_2) + (a_{33}*\Delta x_3)
$$

The total change in output is the sum of the $\Delta y$ vector. Summing up the three equations and collecting like terms gives:

$$
\Delta y = \Delta x_1(a_{11} + a_{21} + a_{31}) + \\ \Delta x_2(a_{12}+a_{22}+a_{32}) + \\\ \Delta x_3(a_{13}+a_{23}+a_{33})
$$
Defining $M_j = \sum^3_{n=1}a_{nj}$ i.e. $M_j$ for the $j$th sector is the sum of column $j$ in the leontief matrix, and represents the output multiplier - the change in total economy output for a one unit change in final demand for sector $j$:

$$
\Delta y = \Delta x_1M_1 + \Delta x_2M_2 + \Delta x_3M_3
$$

Which generalises simply to an input-output analysis with any number, $N$, of sectors:

$$
\Delta y = \sum^N_{n=1}\Delta x_nM_n 
$$

### *GVA and Employment Multipliers*

Gross value added (GVA) multipliers are based on the assumption that the proportion of total output which is comprised of GVA remains unchanged after a change in final demand. GVA is the value of output beyond the value of the inputs, and includes taxes, gross operating surplus, and compensation of employees. Defining for a given sector $n$ the GVA coefficient as $k$ we can calculate the change in GVA:

$$
k_n = \frac{GVA_n}{y_n} \\
$$
Rearranging:
$$
GVA_n = k_n y_n \\
$$
In matrix notation:
$$
\Delta GVA = k \Delta y 
$$
Substitute in the expression for $\Delta y$
$$
\Delta GVA = k \Delta y = \sum^N_{n=1}k_n\Delta x_nM_n 
$$

So the GVA multiplier for sector $n$ is simply the GVA proportion multiplied by the output multiplier - $k_n M_n$. 

A similar approach is taken to the creation of the employment multipliers. We calculate for each sector the employment/output ratio - the number of employees required to make £1 worth of output - and multiply this by the output multiplier. We therefore implicitly make the assumption that employment remains proportional to output, given any change in production.  

### *Implementation in R*

In R, recovery of the multipliers simply involves using the `multipliers()` function. The year to use for employment data and the choice between using number of jobs or FTEs as the employment measure must be selected     . The output is a data frame with 106 observations - 1 per sector - and 11 variables. The variables are the sector names and 5 multipliers (output,gross value added (total),tax,compensation of employees, and gross operating surplus), each calculated in the Type 1 and Type II scenarios.

```{r multipliers}
multipliers <- multipliers(yr = 2010,
                           empl = "fte")
dim(multipliers)
names(multipliers)
head(multipliers[,c(2,3)])
```

## __Step (2a) Data Selection__

The next stage is to model the change in final demand to be analysed in the IO framework. The first stage of this is to select the data to be used. 

- Select the year of data to use.
- The choice of price elasticities to use.
- Whether the analysis is for Scotland or England & Wales

The function `tobalciomodel::final_demand_inputs()` creates a dataset from the package data according to three specified options; year of data to use (default is 2010), whether Scottish data is to be used, or English/Welsh combined data (default is England and Wales), and the source to use for elasticities (default is Meng et al. (2014)). This latter option is only required to model tax and MUP policy changes. 

```{r inputs, eval=FALSE}
inputs <- final_demand_inputs(yr = 2010,
                              scotland = FALSE,
                              elasticity = "meng14")

names(inputs)

head(inputs)
```
## __Step (2b) Policy Parameters__

The next step is to set the policy parameters and apply these to the data created in step 2a. 

- Use the selected data from the previous stage
- Set alcohol policy parameters 
  - exogenous change
  - minimum unit price __(not yet added)__
  - tax changes __(not yet added)__
- apply a policy change to each of the 10 alcohol products. 
- choose whether or not to allow households to re-allocate spending. 
- choose whether or not government simultaneously changes its spending __(not yet added)__

The output of the function is the vector containing changes in final demand. An example of the function; simulate an exogenous change in demand - where consumption of each product of on-trade alcohol falls by 10%.

```{r policy, eval=FALSE}
policy_sim <- simulate_alcohol_policy(data = inputs,
                                      alc.policy = "exog",
                                      on.trade.ch = rep(-0.1,5),
                                      off.trade.ch = c(0,0,0,0,0),
                                      reallocate = FALSE,
                                      prob = FALSE)

names(policy_sim)

head(policy_sim)

policy_sim[61] # Wholesale/Retail (Alcohol)
policy_sim[69] # Accommodation (Alcohol)
policy_sim[71] # Food and Beverage (Alcohol)

```

The above code equally splits the fall in demand for on-trade alcohol across the two on-trade sectors. Instead of a 0.5/0.5 split, we can simulate a distribution of changes in output by drawing a random proportion to allocate from a uniform distribution. 


```{r simulation,eval=FALSE}
### calculate the total change in output

output.effects <- sum(policy_sim*multipliers[,"output.multipliers.type1"])

### see the effect of the random splitting of the on-trade
set.seed(2020)
reps <- 1000
effects.vector <- rep(NA,reps)

for (i in 1:reps) {
  print(paste0("Simulation Iteration: ",i))
  policy_sim <- simulate_alcohol_policy(data = inputs,
                                        alc.policy = "exog",
                                        on.trade.ch = rep(-0.1,5),
                                        off.trade.ch = c(0,0,0,0,0),
                                        reallocate = FALSE,
                                        prob = TRUE)

  effects.vector[i] <- sum(policy_sim*multipliers[,"output.multipliers.type1"])
}
```

```{r sim_plot,eval=FALSE}

library(tidyverse)
data <- data.frame(effects.vector)

ggplot(data=data) +
  aes(x = effects.vector) +
  geom_density(fill="navy",alpha=0.4) +
  geom_vline(xintercept = output.effects) +
  theme_minimal() +
  labs(y = "Density",
       x = "Effect on Output (£bn)",
       title = "Effect of a 10% Fall in Consumption of On-Trade Alcohol Products",
       subtitle = "Distribution of Effects when Varying Split Across Two On-Trade Sectors",
       caption = "1000 simulation replications" ) +
  scale_x_continuous(breaks = seq(-5.0,-3.0,0.1), minor_breaks = NULL)

```

## __Step (3) Calculate the Policy Impact__

Multiply the change in final demand vector calculated in step 2b by the appropriate column of multipliers obtained in step 1. 
