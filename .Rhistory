# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
library(data.table)
# calculate the amount of expenditure that will be reallocated
exp <- -1*(1 - saving_rate)*sum(expenditure)
# select the chosen reallocation vector
if (vector == "hhfce_all") {
v <- as.vector(as.matrix( vectors_data[,2] ))
} else if (vector == "hhfce_noalc") {
v <- as.vector(as.matrix( vectors_data[,3] ))
} else if (vector == "hhfce_notob") {
v <- as.vector(as.matrix( vectors_data[,4] ))
} else if (vector == "hhfce_noalctob") {
v <- as.vector(as.matrix( vectors_data[,5] ))
} else if (vector == "all_hotels") {
v <- as.vector(as.matrix( vectors_data[,6] ))
} else if (vector == "all_rec_durables") {
v <- as.vector(as.matrix( vectors_data[,7] ))
} else if (vector == "all_rec_services") {
v <- as.vector(as.matrix( vectors_data[,8] ))
} else if (vector == "all_clothing") {
v <- as.vector(as.matrix( vectors_data[,9] ))
} else if (vector == "all_furniture") {
v <- as.vector(as.matrix( vectors_data[,10] ))
} else if (vector == "all_appliances") {
v <- as.vector(as.matrix( vectors_data[,11] ))
} else if (vector == "all_vehicles") {
v <- as.vector(as.matrix( vectors_data[,12] ))
} else if (vector == "all_books") {
v <- as.vector(as.matrix( vectors_data[,13] ))
}
# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == 0 + -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
round(sum(hhold_exp$hhold_exp))
-1*(1 - saving_rate)*sum(expenditure)
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == 0 + -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
round(sum(hhold_exp$hhold_exp))
FAI = T
# calculate the amount of expenditure that will be reallocated
exp <- -1*(1 - saving_rate)*sum(expenditure)
# select the chosen reallocation vector
if (vector == "hhfce_all") {
v <- as.vector(as.matrix( vectors_data[,2] ))
} else if (vector == "hhfce_noalc") {
v <- as.vector(as.matrix( vectors_data[,3] ))
} else if (vector == "hhfce_notob") {
v <- as.vector(as.matrix( vectors_data[,4] ))
} else if (vector == "hhfce_noalctob") {
v <- as.vector(as.matrix( vectors_data[,5] ))
} else if (vector == "all_hotels") {
v <- as.vector(as.matrix( vectors_data[,6] ))
} else if (vector == "all_rec_durables") {
v <- as.vector(as.matrix( vectors_data[,7] ))
} else if (vector == "all_rec_services") {
v <- as.vector(as.matrix( vectors_data[,8] ))
} else if (vector == "all_clothing") {
v <- as.vector(as.matrix( vectors_data[,9] ))
} else if (vector == "all_furniture") {
v <- as.vector(as.matrix( vectors_data[,10] ))
} else if (vector == "all_appliances") {
v <- as.vector(as.matrix( vectors_data[,11] ))
} else if (vector == "all_vehicles") {
v <- as.vector(as.matrix( vectors_data[,12] ))
} else if (vector == "all_books") {
v <- as.vector(as.matrix( vectors_data[,13] ))
}
# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == 0 + -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
round(sum(hhold_exp$hhold_exp))
-1*(1 - saving_rate)*sum(expenditure)
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == sum(expenditure) -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
sum(expenditure) -1*(1 - saving_rate)*sum(expenditure)
saving_rate = 0.1
# calculate the amount of expenditure that will be reallocated
exp <- -1*(1 - saving_rate)*sum(expenditure)
# select the chosen reallocation vector
if (vector == "hhfce_all") {
v <- as.vector(as.matrix( vectors_data[,2] ))
} else if (vector == "hhfce_noalc") {
v <- as.vector(as.matrix( vectors_data[,3] ))
} else if (vector == "hhfce_notob") {
v <- as.vector(as.matrix( vectors_data[,4] ))
} else if (vector == "hhfce_noalctob") {
v <- as.vector(as.matrix( vectors_data[,5] ))
} else if (vector == "all_hotels") {
v <- as.vector(as.matrix( vectors_data[,6] ))
} else if (vector == "all_rec_durables") {
v <- as.vector(as.matrix( vectors_data[,7] ))
} else if (vector == "all_rec_services") {
v <- as.vector(as.matrix( vectors_data[,8] ))
} else if (vector == "all_clothing") {
v <- as.vector(as.matrix( vectors_data[,9] ))
} else if (vector == "all_furniture") {
v <- as.vector(as.matrix( vectors_data[,10] ))
} else if (vector == "all_appliances") {
v <- as.vector(as.matrix( vectors_data[,11] ))
} else if (vector == "all_vehicles") {
v <- as.vector(as.matrix( vectors_data[,12] ))
} else if (vector == "all_books") {
v <- as.vector(as.matrix( vectors_data[,13] ))
}
# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == sum(expenditure) -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
sum(expenditure) -1*(1 - saving_rate)*sum(expenditure)
round(sum(hhold_exp$hhold_exp))
library(tobalciomodel)
expenditure = c(-20,-10,-30)
saving_rate = 0.1
vector = "hhfce_noalctob"
vectors_data = tobalciomodel::vectors_hhold
mapping = tobalciomodel::coicop_cpa_mapping
FAI = T
# calculate the amount of expenditure that will be reallocated
exp <- -1*(1 - saving_rate)*sum(expenditure)
# select the chosen reallocation vector
if (vector == "hhfce_all") {
v <- as.vector(as.matrix( vectors_data[,2] ))
} else if (vector == "hhfce_noalc") {
v <- as.vector(as.matrix( vectors_data[,3] ))
} else if (vector == "hhfce_notob") {
v <- as.vector(as.matrix( vectors_data[,4] ))
} else if (vector == "hhfce_noalctob") {
v <- as.vector(as.matrix( vectors_data[,5] ))
} else if (vector == "all_hotels") {
v <- as.vector(as.matrix( vectors_data[,6] ))
} else if (vector == "all_rec_durables") {
v <- as.vector(as.matrix( vectors_data[,7] ))
} else if (vector == "all_rec_services") {
v <- as.vector(as.matrix( vectors_data[,8] ))
} else if (vector == "all_clothing") {
v <- as.vector(as.matrix( vectors_data[,9] ))
} else if (vector == "all_furniture") {
v <- as.vector(as.matrix( vectors_data[,10] ))
} else if (vector == "all_appliances") {
v <- as.vector(as.matrix( vectors_data[,11] ))
} else if (vector == "all_vehicles") {
v <- as.vector(as.matrix( vectors_data[,12] ))
} else if (vector == "all_books") {
v <- as.vector(as.matrix( vectors_data[,13] ))
}
# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == sum(expenditure) -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
library(data.table)
# calculate the amount of expenditure that will be reallocated
exp <- -1*(1 - saving_rate)*sum(expenditure)
# select the chosen reallocation vector
if (vector == "hhfce_all") {
v <- as.vector(as.matrix( vectors_data[,2] ))
} else if (vector == "hhfce_noalc") {
v <- as.vector(as.matrix( vectors_data[,3] ))
} else if (vector == "hhfce_notob") {
v <- as.vector(as.matrix( vectors_data[,4] ))
} else if (vector == "hhfce_noalctob") {
v <- as.vector(as.matrix( vectors_data[,5] ))
} else if (vector == "all_hotels") {
v <- as.vector(as.matrix( vectors_data[,6] ))
} else if (vector == "all_rec_durables") {
v <- as.vector(as.matrix( vectors_data[,7] ))
} else if (vector == "all_rec_services") {
v <- as.vector(as.matrix( vectors_data[,8] ))
} else if (vector == "all_clothing") {
v <- as.vector(as.matrix( vectors_data[,9] ))
} else if (vector == "all_furniture") {
v <- as.vector(as.matrix( vectors_data[,10] ))
} else if (vector == "all_appliances") {
v <- as.vector(as.matrix( vectors_data[,11] ))
} else if (vector == "all_vehicles") {
v <- as.vector(as.matrix( vectors_data[,12] ))
} else if (vector == "all_books") {
v <- as.vector(as.matrix( vectors_data[,13] ))
}
# redistribute the expenditure along the vector
new_exp <- exp*v
new_exp <- cbind(vectors_data[,1],new_exp)
# map the new expenditure onto the CPA categories
merge <- merge.data.table(mapping,
new_exp,
by = "coicop")
merge[, mapped_exp := new_exp*mapping]
# sum up within CPA categories
merge[, total_exp := sum(mapped_exp), by = "CPA_code"]
# collapse
final <- unique(merge[,c("CPA_code","Product","total_exp")])
### Two discrepancies are caused by merged CPA categories in the
### HHFCE table:
#
# (1) H53 (postal and courier) and I55 (accommodation services)
# (2) C27 (electrical equipment) and C28 (machinery and equipment n.e.c)
#
#     Go to the final consumption expenditure by households column
#     in the IOT sheet in "ioat 2017" and construct ratios from the
#     figures given there to break up the categories. (Hard coded here)
x <- merge(final, tobalciomodel::CPA,
by = "CPA_code", sort = FALSE, all = TRUE)
H53_I55 <- as.numeric(x[CPA_code == "CPA_H53&I55","total_exp"])
x[CPA_code == "CPA_H53", total_exp := H53_I55*841/(841+4722)]
x[CPA_code == "CPA_I55", total_exp := H53_I55*4722/(841+4722)]
C27_C28 <- as.numeric(x[CPA_code == "CPA_C27 & C28","total_exp"])
x[CPA_code == "CPA_C27", total_exp := C27_C28*(1348)/(1348+753)]
x[CPA_code == "CPA_C28", total_exp := C27_C28*(753)/(1348+753)]
setkey(x, CPA_code)
x <- x[!"CPA_C27 & C28"]
x <- x[!"CPA_H53&I55"]
x <- x[,c("CPA_code","Product.y","total_exp")]
setnames(x,c("Product.y","total_exp"),c("Product","hhold_exp"))
hhold_exp <- copy(x)
if (FAI == FALSE) {
## add in the initial change to expenditure on tobacco and alcohol
hhold_exp[Product == "Alcoholic beverages  & Tobacco products", hhold_exp := hhold_exp + sum(expenditure)]
} else if (FAI == TRUE) {
## extract the CPA/IOC lookup table and merge, collapsing by FAI categories
merge_data <- unique(tobalciomodel::sic_cpa_fai_mapping[,c("CPA_code","Product","IOC","Sector")])
map_to_FAI <- merge(hhold_exp, merge_data, by = c("CPA_code","Product"))
FAI_data <- map_to_FAI[, .(hhold_exp = sum(hhold_exp)), by = c("IOC","Sector")]
## merge to the names of the FAI IO table to get the 3 disaggregated alcohol sectors
sectors <- as.data.frame(tobalciomodel::iotable_fai[,c("IOC","Sector")])
setDT(sectors)
FAI_data <- merge(sectors, FAI_data, by = c("IOC", "Sector"), all = TRUE, sort = FALSE)
## fill in the three alcohol categories and manufacture of tobacco with the initial changes
## to expenditure - splitting on-trade equally between accommodation/ food and beverage services
FAI_data[61, hhold_exp := expenditure[1]]
FAI_data[c(69,71), hhold_exp := 0.5*expenditure[2]]
FAI_data[18, hhold_exp := expenditure[3]]
## merge again to order sector names properly
hhold_exp <- copy(FAI_data)
}
testthat::expect_true(round(sum(hhold_exp$hhold_exp)) == sum(expenditure) -1*(1 - saving_rate)*sum(expenditure),
label = "Function: ReallocateHhold(). Household expenditure vector must sum to total net change in alcohol and tobacco spending reallocated")
library(tobalciomodel)
library(tobalciomodel)
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
library(tobalciomodel)
library(tobalciomodel)
library(tobalciomodel)
